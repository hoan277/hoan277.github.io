<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Ví dụ Phát Âm Thanh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/vue@3.2.16/dist/vue.global.prod.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        .loading-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <div id="app" class="card p-3 position-relative">
            <div class="loading-spinner" v-if="loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div class="mb-3">
                <label for="textInput" class="form-label">Nhập văn bản:</label>
                <textarea v-model="state.text" class="form-control" id="textInput" rows="3"
                    placeholder="Nhập văn bản cần phát..."></textarea>
            </div>
            <div class="mb-3">
                <label for="voiceSelect" class="form-label">Chọn giọng đọc:</label>
                <select id="voiceSelect" class="form-select" v-model="state.voiceName"></select>
            </div>
            <div class="mb-3">
                <label for="rateInput" class="form-label">Tốc độ đọc:</label>
                <input type="range" class="form-range" id="rateInput" v-model="state.rate" min="0" max="100">
                <div>Giá trị hiện tại: {{ state.rate }}%</div>
            </div>
            <div class="d-flex gap-2 justify-content-center">
                <button @click="speak" class="btn btn-primary">
                    <i class="fas fa-play"></i> Phát
                </button>
                <button @click="pause" class="btn btn-warning">
                    <i class="fas fa-pause"></i> Tạm dừng/Tiếp tục
                </button>
                <button @click="stop" class="btn btn-danger">
                    <i class="fas fa-stop"></i> Dừng
                </button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, reactive, ref, onMounted } = Vue;

        const textEncoder = new TextEncoder();
        const binaryHeadEnd = textEncoder.encode('Path:audio\r\n').toString();

        const speechConfig = () => `X-Timestamp:${new Date().toISOString()}\r\nContent-Type:application/json; charset=utf-8\r\nPath:speech.config\r\n\r\n{"context":{"synthesis":{"audio":{"metadataoptions":{"sentenceBoundaryEnabled":"false","wordBoundaryEnabled":"true"},"outputFormat":"webm-24khz-16bit-mono-opus"}}}}`;

        const ssmlText = (state, voiceName) => {
            const requestId = guid();
            let ssml = `X-RequestId:${requestId}\r\nContent-Type:application/ssml+xml\r\nX-Timestamp:${new Date().toISOString()}\r\nPath:ssml\r\n\r\n<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xmlns:mstts='https://www.w3.org/2001/mstts' xml:lang='${state.lan}'><voice name='${voiceName}'><prosody pitch='${numToString(state.pitch)}Hz' rate ='${numToString(state.rate)}%' volume='${numToString(state.volume)}%'>${state.text}</prosody></voice></speak>`;
            console.log(`ssmlText: ${ssml}`);
            return ssml;
        };

        function guid() {
            return $.map(Array(8), () =>
                Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1)
            ).join('');
        }

        function numToString(num) {
            return num >= 0 ? `+${num}` : `${num}`;
        }

        createApp({
            setup() {
                const state = reactive({
                    text: '',
                    pitch: 0,
                    rate: 30,
                    volume: 0,
                    lan: 'zh-CN',
                    voiceName: 'Microsoft Server Speech Text to Speech Voice (zh-CN, XiaoxiaoNeural)' // Giá trị mặc định
                });

                const audio = ref(null);
                const voiceList = ref([]);
                const loading = ref(false);

                onMounted(async () => {
                    try {
                        const response = await fetch('https://speech.platform.bing.com/consumer/speech/synthesize/readaloud/voices/list?trustedclienttoken=6A5AA1D4EAFF4E9FB37E23D68491D6F4');
                        voiceList.value = await response.json();

                        $('#voiceSelect').select2({
                            data: voiceList.value.map((voice, index) => {
                                const genderIcon = voice.Gender === 'Male' ? 'fas fa-male' : 'fas fa-female';
                                return {
                                    id: voice.Name,
                                    text: `${index + 1}. ${voice.Gender} - ${voice.FriendlyName || voice.ShortName} (${voice.Locale})`
                                };
                            }),
                            placeholder: 'Chọn giọng đọc',
                            width: '100%',
                            escapeMarkup: function (markup) { return markup; }
                        }).on('change', (e) => {
                            state.voiceName = e.target.value;
                        });

                        $('#voiceSelect').val(state.voiceName).trigger('change');
                    } catch (error) {
                        console.error('Lỗi khi lấy danh sách giọng đọc:', error);
                    }
                });

                function speak() {
                    if (!state.text) {
                        console.error('Vui lòng nhập văn bản trước khi phát.');
                        return;
                    }

                    loading.value = true; // Bắt đầu loading
                    const bufferList = [];
                    const ws = new WebSocket("wss://speech.platform.bing.com/consumer/speech/synthesize/readaloud/edge/v1?TrustedClientToken=6A5AA1D4EAFF4E9FB37E23D68491D6F4");

                    ws.onopen = () => {
                        ws.send(speechConfig());
                        ws.send(ssmlText(state, state.voiceName));
                    };

                    ws.onmessage = async ({ data }) => {
                        if (data instanceof Blob) {
                            const view = new Uint8Array(await data.arrayBuffer());
                            bufferList.push(...view.toString().split(binaryHeadEnd)[1].split(',').slice(1).map(i => +i));
                            if (view[0] == 0x00 && view[1] == 0x67 && view[2] == 0x58) {
                                ws.close(1000);
                            }
                        }
                    };

                    ws.onerror = (err) => {
                        console.error('Lỗi kết nối WebSocket:', err);
                        loading.value = false; // Dừng loading nếu có lỗi
                    };

                    ws.onclose = () => {
                        loading.value = false; // Dừng loading
                        if (bufferList.length) {
                            const blob = new Blob([new Uint8Array(bufferList)], { type: 'audio/webm' });
                            const audioUrl = URL.createObjectURL(blob);
                            audio.value = new Audio(audioUrl);
                            audio.value.play();
                        } else {
                            console.error('Không nhận được dữ liệu âm thanh.');
                        }
                    };
                }

                function pause() {
                    if (audio.value) {
                        audio.value.paused ? audio.value.play() : audio.value.pause();
                    }
                }

                function stop() {
                    if (audio.value) {
                        audio.value.pause();
                        audio.value.currentTime = 0;
                    }
                }

                return { state, speak, pause, stop, loading };
            }
        }).mount('#app');
    </script>
</body>

</html>